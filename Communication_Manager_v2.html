<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니케이션 매니저</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .pending { border-left: 4px solid #f97316; }
        .in-progress { border-left: 4px solid #3b82f6; }
        .completed { border-left: 4px solid #10b981; }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            margin-top: 0.25rem;
        }
        .error-icon {
            margin-right: 0.25rem;
            display: inline-block;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.error {
            background: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notificationText"></span>
    </div>

    <!-- Lobby / Start Screen -->
    <div id="lobby-screen" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-lg text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">커뮤니케이션 매니저</h1>
        <p class="text-gray-500 mb-8">시작할 보드를 선택하거나 새로 만드세요.</p>
        
        <!-- User Name Input -->
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <label class="block text-sm font-medium text-gray-700 mb-2">사용자 이름</label>
            <input type="text" id="userNameInput" placeholder="이름을 입력하세요" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
        </div>
        
        <div id="personalBoardWarning" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm text-left">
            <p class="font-bold">⚠️ 개인 보드 접속 제한</p>
            <p class="mt-1">로컬 파일(`file://`)에서는 보안상의 이유로 개인 보드 접속이 제한됩니다. 협업 보드를 이용해 주세요.</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <input type="text" id="boardNameInput" placeholder="새 보드 이름 (예: 11-19 팀)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <p id="boardNameError" class="error-message hidden">
                    <span class="error-icon">!</span> <span id="boardNameErrorText">내용을 입력해주세요.</span>
                </p>
            </div>
            <button id="createBoardButton" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="createBoardText">새 보드 만들기</span>
                <div id="createBoardSpinner" class="loading-spinner mx-auto hidden"></div>
            </button>
            <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">또는</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div>
                <input type="text" id="joinBoardInput" placeholder="기존 보드 이름 입력" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <p id="joinBoardError" class="error-message hidden">
                    <span class="error-icon">!</span> <span id="joinBoardErrorText">내용을 입력해주세요.</span>
                </p>
            </div>
            <button id="joinBoardButton" class="w-full px-6 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="joinBoardText">기존 보드에 참여</span>
                <div id="joinBoardSpinner" class="loading-spinner mx-auto hidden"></div>
            </button>
            <button id="personalBoardButton" class="w-full mt-4 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-bold hover:bg-gray-300 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">개인 보드로 접속</button>
        </div>
    </div>
    
    <!-- Main Application UI -->
    <div id="app-container" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-6xl hidden relative">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">커뮤니케이션 매니저</h1>
            <p class="text-gray-500">들어오는 연락을 실시간으로 관리하고 처리하세요.</p>
        </div>
        
        <button id="returnToLobbyButton" class="absolute top-4 left-4 px-3 py-3 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-300">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4a1 1 0 00-1-1H9a1 1 0 00-1 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
            </svg>
            <span class="sr-only">홈 화면으로 돌아가기</span>
        </button>
    
        <!-- User/Collaboration ID Section -->
        <div class="mb-8 p-4 bg-yellow-100 text-yellow-800 rounded-lg text-sm text-center">
            <p class="font-medium">
                현재 보드: <span id="boardMode" class="font-bold"></span> | 사용자: <span id="currentUser" class="font-bold"></span>
            </p>
            <p id="boardIdDisplay" class="font-bold text-lg mt-1"></p>
            <div id="connectionStatus" class="mt-2 flex items-center justify-center">
                <div class="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                <span class="text-xs">연결됨</span>
            </div>
        </div>
    
        <!-- Add Communication Form -->
        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="sourceNameInput" placeholder="이름" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="50">
                <input type="tel" id="sourcePhoneInput" placeholder="전화번호 (예: 010-1234-5678)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="20">
                <input type="text" id="whereInput" placeholder="위치 (예: 무대 왼쪽)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="100">
                <input type="text" id="whatInput" placeholder="문제 내용 (예: 마이크 문제)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="200">
                <input type="text" id="assigneeInput" placeholder="담당자" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none col-span-1 md:col-span-2" maxlength="50">
            </div>
            <button id="addButton" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="addButtonText">요청 추가</span>
                <div id="addButtonSpinner" class="loading-spinner mx-auto hidden"></div>
            </button>
            <button id="downloadButton" class="w-full mt-2 px-6 py-3 bg-gray-400 text-white rounded-lg font-bold hover:bg-gray-500 transition duration-300">CSV로 다운로드</button>
        </div>

        <!-- Statistics -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">통계</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white p-3 rounded-lg">
                    <div class="text-2xl font-bold text-orange-500" id="totalPending">0</div>
                    <div class="text-sm text-gray-600">새 요청</div>
                </div>
                <div class="bg-white p-3 rounded-lg">
                    <div class="text-2xl font-bold text-blue-500" id="totalInProgress">0</div>
                    <div class="text-sm text-gray-600">진행 중</div>
                </div>
                <div class="bg-white p-3 rounded-lg">
                    <div class="text-2xl font-bold text-green-500" id="totalCompleted">0</div>
                    <div class="text-sm text-gray-600">완료</div>
                </div>
                <div class="bg-white p-3 rounded-lg">
                    <div class="text-2xl font-bold text-gray-700" id="totalRequests">0</div>
                    <div class="text-sm text-gray-600">전체</div>
                </div>
            </div>
        </div>
    
        <!-- Status Columns -->
        <div id="statusContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Pending Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-orange-500 mb-4">새 요청 <span id="pendingCount" class="ml-2 text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="pendingList" class="space-y-4 min-h-[100px]"></div>
            </div>
    
            <!-- In Progress Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-blue-500 mb-4">진행 중 <span id="inProgressCount" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="inProgressList" class="space-y-4 min-h-[100px]"></div>
            </div>
    
            <!-- Completed Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-green-500 mb-4">완료 <span id="completedCount" class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="completedList" class="space-y-4 min-h-[100px]"></div>
            </div>
        </div>
    
        <!-- Custom Modal for Alerts -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl text-center max-w-md">
                <p id="modalMessage" class="mb-4 text-gray-800"></p>
                <button id="modalClose" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">확인</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, setLogLevel, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase 설정
        const firebaseConfig = {
          apiKey: "AIzaSyCJnT6FgIBNX3acYkIK5usVWuTgd0B4NHU",
          authDomain: "communication-manager-v2.firebaseapp.com",
          projectId: "communication-manager-v2",
          storageBucket: "communication-manager-v2.firebasestorage.app",
          messagingSenderId: "44832093872",
          appId: "1:44832093872:web:6d12dae68fb0ba5cbdad75",
          measurementId: "G-73LR37M0L3"
        };
        
        const app = initializeApp(firebaseConfig);
        const appId = firebaseConfig.projectId;
        
        let userName = localStorage.getItem('communicationManagerUserName') || '';
        let isAuthReady = false;
        let db, auth, userId;
        let unsubscribe = null;
        let currentBoardData = [];
        let currentCollectionPath = '';

        // DOM Elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const appContainer = document.getElementById('app-container');
        const userNameInput = document.getElementById('userNameInput');
        const boardNameInput = document.getElementById('boardNameInput');
        const boardNameError = document.getElementById('boardNameError');
        const boardNameErrorText = document.getElementById('boardNameErrorText');
        const createBoardButton = document.getElementById('createBoardButton');
        const createBoardText = document.getElementById('createBoardText');
        const createBoardSpinner = document.getElementById('createBoardSpinner');
        const joinBoardInput = document.getElementById('joinBoardInput');
        const joinBoardError = document.getElementById('joinBoardError');
        const joinBoardErrorText = document.getElementById('joinBoardErrorText');
        const joinBoardButton = document.getElementById('joinBoardButton');
        const joinBoardText = document.getElementById('joinBoardText');
        const joinBoardSpinner = document.getElementById('joinBoardSpinner');
        const personalBoardButton = document.getElementById('personalBoardButton');
        const returnToLobbyButton = document.getElementById('returnToLobbyButton');
        const downloadButton = document.getElementById('downloadButton');
        const personalBoardWarning = document.getElementById('personalBoardWarning');
        const boardMode = document.getElementById('boardMode');
        const boardIdDisplay = document.getElementById('boardIdDisplay');
        const currentUser = document.getElementById('currentUser');
        const connectionStatus = document.getElementById('connectionStatus');
        const sourceNameInput = document.getElementById('sourceNameInput');
        const sourcePhoneInput = document.getElementById('sourcePhoneInput');
        const whereInput = document.getElementById('whereInput');
        const whatInput = document.getElementById('whatInput');
        const assigneeInput = document.getElementById('assigneeInput');
        const addButton = document.getElementById('addButton');
        const addButtonText = document.getElementById('addButtonText');
        const addButtonSpinner = document.getElementById('addButtonSpinner');
        const pendingList = document.getElementById('pendingList');
        const inProgressList = document.getElementById('inProgressList');
        const completedList = document.getElementById('completedList');
        const pendingCount = document.getElementById('pendingCount');
        const inProgressCount = document.getElementById('inProgressCount');
        const completedCount = document.getElementById('completedCount');
        const totalPending = document.getElementById('totalPending');
        const totalInProgress = document.getElementById('totalInProgress');
        const totalCompleted = document.getElementById('totalCompleted');
        const totalRequests = document.getElementById('totalRequests');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalClose = document.getElementById('modalClose');
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        // Utility Functions
        function showNotification(message, isError = false) {
            notificationText.textContent = message;
            notification.className = `notification ${isError ? 'error' : ''} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function sanitizeInput(input) {
            return input.replace(/[<>]/g, '');
        }

        function validatePhoneNumber(phone) {
            const phoneRegex = /^[\d\-\+\(\)\s]{10,20}$/;
            return phoneRegex.test(phone);
        }

        function updateConnectionStatus(isConnected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            if (isConnected) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                statusText.textContent = '연결됨';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                statusText.textContent = '연결 끊김';
            }
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Initialize user name
        if (userName) {
            userNameInput.value = userName;
        }

        userNameInput.addEventListener('input', (e) => {
            userName = sanitizeInput(e.target.value.trim());
            localStorage.setItem('communicationManagerUserName', userName);
        });
        
        if (window.location.protocol === 'file:') {
            personalBoardWarning.classList.remove('hidden');
            personalBoardButton.disabled = true;
        }

        try {
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('silent');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("사용자 인증 완료:", userId);
                    updateConnectionStatus(true);
                    setTimeout(() => {
                        if (window.location.protocol !== 'file:') {
                            personalBoardButton.disabled = false;
                        }
                    }, 500);
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("인증 오류:", error);
                        showNotification("인증에 실패했습니다.", true);
                        updateConnectionStatus(false);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase 초기화 실패:", error);
            showNotification("Firebase 연결에 실패했습니다.", true);
            updateConnectionStatus(false);
        }

        function updateBoard(mode, id, collectionPath) {
            if (unsubscribe) {
                unsubscribe();
            }
            currentCollectionPath = collectionPath;
            boardMode.textContent = mode;
            boardIdDisplay.textContent = id;
            currentUser.textContent = userName || '익명';
            startRealtimeListener(collectionPath);
            lobbyScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            if (assigneeInput && userName) {
                assigneeInput.value = userName;
            }
        }
        
        function createCommunicationCard(doc) {
            const data = doc.data();
            const card = document.createElement('div');
            card.id = `card-${doc.id}`;
            card.className = `card p-4 rounded-lg bg-white flex flex-col gap-2 ${data.status}`;
            
            const timeAgo = data.timestamp ? getTimeAgo(data.timestamp.toDate()) : '';
            
            const displayHTML = `
                <div class="flex items-center justify-between cursor-pointer collapsible-header">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800">이름: ${sanitizeInput(data.name || '없음')}</p>
                        <p class="text-sm text-gray-400">담당자: ${sanitizeInput(data.assignee || '미지정')}</p>
                        ${timeAgo ? `<p class="text-xs text-gray-400">${timeAgo}</p>` : ''}
                    </div>
                    <svg class="w-5 h-5 ml-2 text-gray-400 transform transition-transform duration-300 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="collapsible-content space-y-2 text-sm text-gray-600 hidden">
                    <p><strong>전화번호:</strong> ${sanitizeInput(data.phone || '없음')}</p>
                    <p><strong>위치:</strong> ${sanitizeInput(data.where || '없음')}</p>
                    <p><strong>내용:</strong> ${sanitizeInput(data.what || '없음')}</p>
                    ${data.timestamp ? `<p class="text-xs text-gray-400 mt-2">요청 시간: ${data.timestamp.toDate().toLocaleString('ko-KR')}</p>` : ''}
                    <p class="text-xs text-gray-400">작성자: ${sanitizeInput(data.authorName || '익명')}</p>
                </div>
            `;
            
            const editFormHTML = `
                <div class="flex flex-col gap-2 edit-form hidden" id="edit-form-${doc.id}">
                    <input type="text" id="edit-name-${doc.id}" value="${sanitizeInput(data.name || '')}" placeholder="이름" class="p-2 border rounded text-sm" maxlength="50">
                    <input type="tel" id="edit-phone-${doc.id}" value="${sanitizeInput(data.phone || '')}" placeholder="전화번호" class="p-2 border rounded text-sm" maxlength="20">
                    <input type="text" id="edit-where-${doc.id}" value="${sanitizeInput(data.where || '')}" placeholder="위치" class="p-2 border rounded text-sm" maxlength="100">
                    <input type="text" id="edit-what-${doc.id}" value="${sanitizeInput(data.what || '')}" placeholder="내용" class="p-2 border rounded text-sm" maxlength="200">
                    <input type="text" id="edit-assignee-${doc.id}" value="${sanitizeInput(data.assignee || '')}" placeholder="담당자" class="p-2 border rounded text-sm" maxlength="50">
                </div>
            `;
            
            const buttonHTML = `
                <div class="flex gap-2 mt-2 flex-wrap">
                    ${data.status === 'pending' ?
                        `<button data-status="in_progress" data-id="${doc.id}" class="status-btn px-4 py-2 bg-blue-500 text-white rounded-full text-xs font-semibold hover:bg-blue-600 transition duration-200">진행 중으로</button>` : ''
                    }
                    ${data.status === 'in_progress' ?
                        `<button data-status="completed" data-id="${doc.id}" class="status-btn px-4 py-2 bg-green-500 text-white rounded-full text-xs font-semibold hover:bg-green-600 transition duration-200">완료로</button>` : ''
                    }
                    ${data.status === 'completed' ?
                        `<span class="text-xs text-green-600 bg-green-100 py-1 px-3 rounded-full">처리 완료됨</span>` : ''
                    }
                    ${data.status !== 'completed' ?
                        `<button class="edit-btn px-4 py-2 bg-gray-500 text-white rounded-full text-xs font-semibold hover:bg-gray-600 transition duration-200" data-id="${doc.id}">수정</button>` : ''
                    }
                </div>
            `;

            card.innerHTML = `
                <div class="display-view">${displayHTML}</div>
                ${editFormHTML}
                ${buttonHTML}
                <div class="edit-buttons hidden flex gap-2 mt-2">
                    <button class="save-btn px-4 py-2 bg-green-500 text-white rounded-full text-xs font-semibold hover:bg-green-600 transition duration-200" data-id="${doc.id}">저장</button>
                    <button class="cancel-btn px-4 py-2 bg-gray-500 text-white rounded-full text-xs font-semibold hover:bg-gray-600 transition duration-200" data-id="${doc.id}">취소</button>
                </div>
            `;

            card.querySelector('.collapsible-header').addEventListener('click', (e) => {
                e.stopPropagation();
                const content = card.querySelector('.collapsible-content');
                const icon = card.querySelector('.collapsible-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
            return card;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return '방금 전';
            } else if (diffInSeconds < 3600) {
                return `${Math.floor(diffInSeconds / 60)}분 전`;
            } else if (diffInSeconds < 86400) {
                return `${Math.floor(diffInSeconds / 3600)}시간 전`;
            } else {
                return `${Math.floor(diffInSeconds / 86400)}일 전`;
            }
        }

        function startRealtimeListener(collectionPath) {
            if (!isAuthReady) {
                console.error("인증이 준비되지 않았습니다.");
                showNotification("인증이 준비되지 않았습니다.", true);
                return;
            }

            const communicationRef = collection(db, collectionPath);
            console.log("컬렉션 리스닝 시작:", collectionPath);

            unsubscribe = onSnapshot(communicationRef, (snapshot) => {
                currentBoardData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // 기존 이벤트 리스너 제거를 위해 내용을 완전히 교체
                pendingList.innerHTML = '';
                inProgressList.innerHTML = '';
                completedList.innerHTML = '';

                let pendingCountVal = 0;
                let inProgressCountVal = 0;
                let completedCountVal = 0;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const card = createCommunicationCard(doc);
                    
                    if (data.status === 'pending') {
                        pendingList.appendChild(card);
                        pendingCountVal++;
                    } else if (data.status === 'in_progress') {
                        inProgressList.appendChild(card);
                        inProgressCountVal++;
                    } else if (data.status === 'completed') {
                        completedList.appendChild(card);
                        completedCountVal++;
                    }
                });

                // 카운터 업데이트
                pendingCount.textContent = pendingCountVal;
                inProgressCount.textContent = inProgressCountVal;
                completedCount.textContent = completedCountVal;
                totalPending.textContent = pendingCountVal;
                totalInProgress.textContent = inProgressCountVal;
                totalCompleted.textContent = completedCountVal;
                totalRequests.textContent = pendingCountVal + inProgressCountVal + completedCountVal;

                // 이벤트 리스너 재등록
                attachEventListeners();
                
            }, (error) => {
                console.error("Firestore 리스너 오류:", error);
                showNotification("데이터를 불러오는 중 오류가 발생했습니다.", true);
                updateConnectionStatus(false);
            });
        }

        function attachEventListeners() {
            // 상태 변경 버튼
            document.querySelectorAll('.status-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const newStatus = e.target.dataset.status;
                    const docId = e.target.dataset.id;
                    if (!docId) {
                        showNotification("문서 ID를 찾을 수 없습니다.", true);
                        return;
                    }
                    
                    // 버튼 비활성화
                    button.disabled = true;
                    button.style.opacity = '0.5';
                    
                    try {
                        const communicationDocRef = doc(db, `${currentCollectionPath}/${docId}`);
                        await updateDoc(communicationDocRef, { status: newStatus });
                        console.log(`문서 ${docId}의 상태가 ${newStatus}로 변경됨`);
                        showNotification("상태가 성공적으로 변경되었습니다.");
                    } catch (error) {
                        console.error("문서 업데이트 중 오류:", error);
                        showNotification("상태 변경 중 오류가 발생했습니다.", true);
                        button.disabled = false;
                        button.style.opacity = '1';
                    }
                });
            });

            // 수정 버튼
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    const cardElement = document.getElementById(`card-${docId}`);
                    const displayView = cardElement.querySelector('.display-view');
                    const editView = cardElement.querySelector(`#edit-form-${docId}`);
                    const editButtons = cardElement.querySelector('.edit-buttons');

                    displayView.classList.add('hidden');
                    editView.classList.remove('hidden');
                    editButtons.classList.remove('hidden');
                    
                    const statusButtons = cardElement.querySelectorAll('.status-btn, .edit-btn');
                    statusButtons.forEach(btn => btn.classList.add('hidden'));
                });
            });

            // 저장 버튼
            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const docId = e.target.dataset.id;
                    const cardElement = document.getElementById(`card-${docId}`);
                    const name = sanitizeInput(cardElement.querySelector(`#edit-name-${docId}`).value.trim());
                    const phone = sanitizeInput(cardElement.querySelector(`#edit-phone-${docId}`).value.trim());
                    const where = sanitizeInput(cardElement.querySelector(`#edit-where-${docId}`).value.trim());
                    const what = sanitizeInput(cardElement.querySelector(`#edit-what-${docId}`).value.trim());
                    const assignee = sanitizeInput(cardElement.querySelector(`#edit-assignee-${docId}`).value.trim());
                    
                    // 유효성 검사
                    if (!name || !phone || !where || !what || !assignee) {
                        showNotification("모든 필드를 입력해주세요.", true);
                        return;
                    }
                    
                    if (!validatePhoneNumber(phone)) {
                        showNotification("올바른 전화번호 형식을 입력해주세요.", true);
                        return;
                    }
                    
                    // 버튼 비활성화
                    button.disabled = true;
                    button.textContent = '저장 중...';
                    
                    try {
                        const communicationDocRef = doc(db, `${currentCollectionPath}/${docId}`);
                        await updateDoc(communicationDocRef, {
                            name, phone, where, what, assignee
                        });
                        showNotification("요청이 성공적으로 수정되었습니다.");
                        console.log(`문서 ${docId} 수정 완료`);
                    } catch (error) {
                        console.error("문서 수정 중 오류:", error);
                        showNotification("요청 수정 중 오류가 발생했습니다.", true);
                        button.disabled = false;
                        button.textContent = '저장';
                    }
                });
            });

            // 취소 버튼
            document.querySelectorAll('.cancel-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.target.dataset.id;
                    const cardElement = document.getElementById(`card-${docId}`);
                    const displayView = cardElement.querySelector('.display-view');
                    const editView = cardElement.querySelector(`#edit-form-${docId}`);
                    const editButtons = cardElement.querySelector('.edit-buttons');

                    displayView.classList.remove('hidden');
                    editView.classList.add('hidden');
                    editButtons.classList.add('hidden');
                    
                    const statusButtons = cardElement.querySelectorAll('.status-btn, .edit-btn');
                    statusButtons.forEach(btn => btn.classList.remove('hidden'));
                });
            });
        }

        function downloadAsCsv() {
            if (currentBoardData.length === 0) {
                showNotification("다운로드할 데이터가 없습니다.", true);
                return;
            }

            const headers = ["타임스탬프", "이름", "전화번호", "위치", "내용", "담당자", "상태", "작성자"];
            
            const rows = currentBoardData.map(item => {
                const timestamp = item.timestamp ? item.timestamp.toDate().toLocaleString('ko-KR') : '';
                const name = `"${(item.name || '').replace(/"/g, '""')}"`;
                const phone = `"${(item.phone || '').replace(/"/g, '""')}"`;
                const where = `"${(item.where || '').replace(/"/g, '""')}"`;
                const what = `"${(item.what || '').replace(/"/g, '""')}"`;
                const assignee = `"${(item.assignee || '').replace(/"/g, '""')}"`;
                const statusText = item.status === 'pending' ? '새 요청' : 
                                 item.status === 'in_progress' ? '진행 중' : '완료';
                const status = `"${statusText}"`;
                const authorName = `"${(item.authorName || '').replace(/"/g, '""')}"`;
                return [timestamp, name, phone, where, what, assignee, status, authorName].join(',');
            });

            const csvString = [
                headers.join(','),
                ...rows
            ].join('\n');
            
            const BOM = "\uFEff";
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const now = new Date();
            const dateString = now.toISOString().slice(0, 10);
            link.download = `communications_${dateString}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification("CSV 파일이 다운로드되었습니다.");
        }

        function setButtonLoading(button, textElement, spinner, isLoading) {
            if (isLoading) {
                button.disabled = true;
                textElement.classList.add('hidden');
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                textElement.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }

        // Event Listeners
        createBoardButton.addEventListener('click', async () => {
            if (!userName.trim()) {
                showNotification("사용자 이름을 입력해주세요.", true);
                userNameInput.focus();
                return;
            }
            
            const boardName = sanitizeInput(boardNameInput.value.trim());
            if (boardName === '') {
                boardNameErrorText.textContent = "내용을 입력해주세요.";
                boardNameError.classList.remove('hidden');
                boardNameInput.focus();
                return;
            }
            
            if (boardName.length < 2 || boardName.length > 30) {
                boardNameErrorText.textContent = "보드 이름은 2-30자 사이여야 합니다.";
                boardNameError.classList.remove('hidden');
                boardNameInput.focus();
                return;
            }
            
            boardNameError.classList.add('hidden');
        
            if (!isAuthReady) {
                showNotification("인증 준비 중입니다. 잠시 후 다시 시도해주세요.", true);
                return;
            }
        
            setButtonLoading(createBoardButton, createBoardText, createBoardSpinner, true);
        
            try {
                const publicCollectionPath = `artifacts/${appId}/public/data/${boardName}`;
                const publicDocs = await getDocs(collection(db, publicCollectionPath));
        
                if (publicDocs.empty) {
                    updateBoard('협업 보드', boardName, publicCollectionPath);
                    console.log(`새 보드 '${boardName}' 생성 완료`);
                    showNotification(`보드 '${boardName}'가 생성되었습니다.`);
                } else {
                    boardNameErrorText.textContent = "이미 존재하는 보드입니다. '기존 보드에 참여'를 이용해주세요.";
                    boardNameError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("보드 생성 오류:", error);
                showNotification("보드 생성 중 오류가 발생했습니다.", true);
            } finally {
                setButtonLoading(createBoardButton, createBoardText, createBoardSpinner, false);
            }
        });

        joinBoardButton.addEventListener('click', async () => {
            if (!userName.trim()) {
                showNotification("사용자 이름을 입력해주세요.", true);
                userNameInput.focus();
                return;
            }
            
            const boardName = sanitizeInput(joinBoardInput.value.trim());
            if (boardName === '') {
                joinBoardErrorText.textContent = "내용을 입력해주세요.";
                joinBoardError.classList.remove('hidden');
                joinBoardInput.focus();
                return;
            }
            
            joinBoardError.classList.add('hidden');
        
            if (!isAuthReady) {
                showNotification("인증 준비 중입니다. 잠시 후 다시 시도해주세요.", true);
                return;
            }
        
            setButtonLoading(joinBoardButton, joinBoardText, joinBoardSpinner, true);
        
            try {
                const publicCollectionPath = `artifacts/${appId}/public/data/${boardName}`;
                const publicDocs = await getDocs(collection(db, publicCollectionPath));
        
                if (publicDocs.empty) {
                    joinBoardErrorText.textContent = "해당 보드가 존재하지 않습니다.";
                    joinBoardError.classList.remove('hidden');
                } else {
                    updateBoard('협업 보드', boardName, publicCollectionPath);
                    console.log(`기존 보드 '${boardName}' 참여 완료`);
                    showNotification(`보드 '${boardName}'에 참여했습니다.`);
                }
            } catch (error) {
                console.error("보드 참여 오류:", error);
                showNotification("보드 참여 중 오류가 발생했습니다.", true);
            } finally {
                setButtonLoading(joinBoardButton, joinBoardText, joinBoardSpinner, false);
            }
        });

        personalBoardButton.addEventListener('click', async () => {
            if (!userName.trim()) {
                showNotification("사용자 이름을 입력해주세요.", true);
                userNameInput.focus();
                return;
            }
            
            if (!isAuthReady) {
                showNotification("인증 준비 중입니다. 잠시 후 다시 시도해주세요.", true);
                return;
            }
            const personalCollectionPath = `artifacts/${appId}/users/${userId}/communications`;
            updateBoard('개인 보드', `사용자: ${userId.substring(0, 8)}...`, personalCollectionPath);
            showNotification("개인 보드에 접속했습니다.");
        });

        addButton.addEventListener('click', async () => {
            const name = sanitizeInput(sourceNameInput.value.trim());
            const phone = sanitizeInput(sourcePhoneInput.value.trim());
            const where = sanitizeInput(whereInput.value.trim());
            const what = sanitizeInput(whatInput.value.trim());
            const assignee = sanitizeInput(assigneeInput.value.trim());
        
            if (!name || !phone || !where || !what || !assignee) {
                showNotification("모든 필드를 입력해주세요.", true);
                return;
            }
            
            if (!validatePhoneNumber(phone)) {
                showNotification("올바른 전화번호 형식을 입력해주세요.", true);
                sourcePhoneInput.focus();
                return;
            }

            if (!isAuthReady || !currentCollectionPath) {
                showNotification("보드에 접속해야 요청을 추가할 수 있습니다.", true);
                return;
            }
        
            setButtonLoading(addButton, addButtonText, addButtonSpinner, true);
        
            try {
                await addDoc(collection(db, currentCollectionPath), {
                    name,
                    phone,
                    where,
                    what,
                    assignee,
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    authorName: userName,
                });
                
                // 입력 필드 초기화
                sourceNameInput.value = '';
                sourcePhoneInput.value = '';
                whereInput.value = '';
                whatInput.value = '';
                assigneeInput.value = userName; // 담당자는 현재 사용자로 유지
                
                showNotification("요청이 성공적으로 추가되었습니다.");
            } catch (error) {
                console.error("문서 추가 중 오류:", error);
                showNotification("요청 추가 중 오류가 발생했습니다.", true);
            } finally {
                setButtonLoading(addButton, addButtonText, addButtonSpinner, false);
            }
        });

        returnToLobbyButton.addEventListener('click', () => {
            lobbyScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (unsubscribe) {
                unsubscribe();
            }
            
            // 입력 필드 초기화
            boardNameInput.value = '';
            joinBoardInput.value = '';
            boardNameError.classList.add('hidden');
            joinBoardError.classList.add('hidden');
            
            // 메인 앱 필드 초기화
            sourceNameInput.value = '';
            sourcePhoneInput.value = '';
            whereInput.value = '';
            whatInput.value = '';
            assigneeInput.value = '';
            
            currentCollectionPath = '';
            currentBoardData = [];
        });

        downloadButton.addEventListener('click', downloadAsCsv);

        // 키보드 단축키
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'Enter':
                        e.preventDefault();
                        if (!appContainer.classList.contains('hidden')) {
                            addButton.click();
                        }
                        break;
                    case 's':
                        e.preventDefault();
                        if (!appContainer.classList.contains('hidden')) {
                            downloadButton.click();
                        }
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                modal.classList.add('hidden');
            }
        });

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) {
                unsubscribe();
            }
        });

        // 온라인/오프라인 상태 감지
        window.addEventListener('online', () => {
            updateConnectionStatus(true);
            showNotification("인터넷에 연결되었습니다.");
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus(false);
            showNotification("인터넷 연결이 끊어졌습니다.", true);
        });

        console.log("커뮤니케이션 매니저가 성공적으로 초기화되었습니다.");
    </script>
</body>
</html>