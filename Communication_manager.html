<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>커뮤니케이션 매니저</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .pending { border-left: 4px solid #f97316; }
        .in-progress { border-left: 4px solid #3b82f6; }
        .completed { border-left: 4px solid #10b981; }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            margin-top: 0.25rem;
        }
        .error-icon {
            margin-right: 0.25rem;
            display: inline-block;
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        .input-error {
            border-color: #ef4444 !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Lobby / Start Screen -->
    <div id="lobby-screen" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-lg text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">커뮤니케이션 매니저</h1>
        <p class="text-gray-500 mb-8">시작할 보드를 선택하거나 새로 만드세요.</p>
        
        <div id="personalBoardWarning" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm text-left">
            <p class="font-bold"⚠️ 개인 보드 접속 제한</p>
            <p class="mt-1">로컬 파일(`file://`)에서는 보안상의 이유로 개인 보드 접속이 제한됩니다. 협업 보드를 이용해 주세요.</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <input type="text" id="boardNameInput" placeholder="새 보드 이름 (예: 11-19 팀)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <p id="boardNameError" class="error-message hidden">
                    <span class="error-icon">!</span> 내용을 입력해주세요.
                </p>
            </div>
            <button id="createBoardButton" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300">새 보드 만들기</button>
            <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">또는</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <div>
                <input type="text" id="joinBoardInput" placeholder="기존 보드 이름 입력" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <p id="joinBoardError" class="error-message hidden">
                    <span class="error-icon">!</span> 내용을 입력해주세요.
                </p>
            </div>
            <button id="joinBoardButton" class="w-full px-6 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition duration-300">기존 보드에 참여</button>
            <button id="personalBoardButton" class="w-full mt-4 px-6 py-3 bg-gray-200 text-gray-800 rounded-lg font-bold hover:bg-gray-300 transition duration-300 opacity-50 cursor-not-allowed" disabled>개인 보드로 접속</button>
        </div>
    </div>
    
    <!-- Main Application UI -->
    <div id="app-container" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full max-w-6xl hidden relative">
        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">커뮤니케이션 매니저</h1>
            <p class="text-gray-500">들어오는 연락을 실시간으로 관리하고 처리하세요.</p>
        </div>
        
        <button id="returnToLobbyButton" class="absolute top-4 left-4 px-3 py-3 rounded-full bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-300">
            <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4a1 1 0 00-1-1H9a1 1 0 00-1 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
            </svg>
            <span class="sr-only">홈 화면으로 돌아가기</span>
        </button>
    
        <!-- User/Collaboration ID Section -->
        <div class="mb-8 p-4 bg-yellow-100 text-yellow-800 rounded-lg text-sm text-center">
            <p class="font-medium">
                현재 보드: <span id="boardMode" class="font-bold"></span>
            </p>
            <p id="boardIdDisplay" class="font-bold text-lg mt-1"></p>
        </div>
    
        <!-- Add Communication Form -->
        <div class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="sourceNameInput" placeholder="이름" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="text" id="sourcePhoneInput" placeholder="번호" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="text" id="whereInput" placeholder="위치 (예: 무대 왼쪽)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="text" id="whatInput" placeholder="문제 내용 (예: 마이크 문제)" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <input type="text" id="assigneeInput" placeholder="수신자" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none col-span-1 md:col-span-2">
            </div>
            <button id="addButton" class="w-full mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition duration-300">요청 추가</button>
            <button id="downloadButton" class="w-full mt-2 px-6 py-3 bg-gray-400 text-white rounded-lg font-bold hover:bg-gray-500 transition duration-300">CSV로 다운로드</button>
        </div>

        <!-- Auto-save controls -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg flex flex-col md:flex-row items-center justify-between">
            <span class="text-sm font-medium text-gray-700 mb-2 md:mb-0">자동 저장 설정:</span>
            <div class="flex items-center space-x-2">
                <select id="autoSaveInterval" class="p-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <option value="10000">10초</option>
                    <option value="30000">30초</option>
                    <option value="60000">1분</option>
                    <option value="600000">10분</option>
                    <option value="1800000">30분</option>
                </select>
                <button id="startAutoSaveButton" class="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold hover:bg-green-600 transition duration-300 text-sm">자동 저장 시작</button>
                <button id="stopAutoSaveButton" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-300 text-sm hidden">자동 저장 중지</button>
            </div>
            <span id="autoSaveStatus" class="text-sm font-medium text-green-600 mt-2 md:mt-0"></span>
        </div>
    
        <!-- Status Columns -->
        <div id="statusContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Pending Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-orange-500 mb-4">새 요청 <span id="pendingCount" class="ml-2 text-sm bg-orange-100 text-orange-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="pendingList" class="space-y-4 min-h-[100px]"></div>
            </div>
    
            <!-- In Progress Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-blue-500 mb-4">진행 중 <span id="inProgressCount" class="ml-2 text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="inProgressList" class="space-y-4 min-h-[100px]"></div>
            </div>
    
            <!-- Completed Column -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h2 class="text-lg font-semibold text-green-500 mb-4">완료 <span id="completedCount" class="ml-2 text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full">0</span></h2>
                <div id="completedList" class="space-y-4 min-h-[100px]"></div>
            </div>
        </div>
    
        <!-- Custom Modal for Alerts -->
        <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl text-center">
                <p id="modalMessage" class="mb-4 text-gray-800"></p>
                <button id="modalClose" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">확인</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, updateDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let userName = '김태양'; // User's name to be used for authoring and assignee
        let isAuthReady = false;
        let db, auth, userId;
        let unsubscribe = null; // Unsubscribe function for the realtime listener
        let currentBoardData = []; // Global variable to store current board data
        let autoSaveIntervalId = null; // For auto-save functionality

        // DOM elements
        const lobbyScreen = document.getElementById('lobby-screen');
        const appContainer = document.getElementById('app-container');
        const boardNameInput = document.getElementById('boardNameInput');
        const boardNameError = document.getElementById('boardNameError');
        const createBoardButton = document.getElementById('createBoardButton');
        const joinBoardInput = document.getElementById('joinBoardInput');
        const joinBoardError = document.getElementById('joinBoardError');
        const joinBoardButton = document.getElementById('joinBoardButton');
        const personalBoardButton = document.getElementById('personalBoardButton');
        const returnToLobbyButton = document.getElementById('returnToLobbyButton');
        const downloadButton = document.getElementById('downloadButton');
        const autoSaveIntervalSelect = document.getElementById('autoSaveInterval');
        const startAutoSaveButton = document.getElementById('startAutoSaveButton');
        const stopAutoSaveButton = document.getElementById('stopAutoSaveButton');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const personalBoardWarning = document.getElementById('personalBoardWarning');

        // Main App UI elements
        const boardMode = document.getElementById('boardMode');
        const boardIdDisplay = document.getElementById('boardIdDisplay');
        const sourceNameInput = document.getElementById('sourceNameInput');
        const sourcePhoneInput = document.getElementById('sourcePhoneInput');
        const whereInput = document.getElementById('whereInput');
        const whatInput = document.getElementById('whatInput');
        const assigneeInput = document.getElementById('assigneeInput');
        const addButton = document.getElementById('addButton');
        const pendingList = document.getElementById('pendingList');
        const inProgressList = document.getElementById('inProgressList');
        const completedList = document.getElementById('completedList');
        const pendingCount = document.getElementById('pendingCount');
        const inProgressCount = document.getElementById('inProgressCount');
        const completedCount = document.getElementById('completedCount');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modalMessage');
        const modalClose = document.getElementById('modalClose');

        // Function to show the modal (for general errors)
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });
        
        // Check if the app is running as a local file and show a warning
        if (window.location.protocol === 'file:') {
            personalBoardWarning.classList.remove('hidden');
            personalBoardButton.disabled = true;
            personalBoardButton.classList.add('opacity-50', 'cursor-not-allowed');
        }


        // Firebase initialization
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            // Listen for authentication state changes and enable the button when ready.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User signed in with ID:", userId);
                    // Add a small delay to ensure the UI has rendered the authenticated state
                    setTimeout(() => {
                        if (window.location.protocol !== 'file:') {
                            personalBoardButton.disabled = false;
                            personalBoardButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    }, 500);
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                        // showModal("인증 중 오류가 발생했습니다. 나중에 다시 시도해주세요.");
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed.", error);
            // showModal("애플리케이션 초기화에 실패했습니다. 관리자에게 문의하세요.");
        }

        // Function to update board info and switch UI
        function updateBoard(mode, id, collectionPath) {
            if (unsubscribe) {
                unsubscribe();
            }
            boardMode.textContent = mode;
            boardIdDisplay.textContent = id;
            startRealtimeListener(collectionPath);
            lobbyScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            // Do not auto-fill the name input anymore
            if (assigneeInput) {
                assigneeInput.value = userName;
            }
        }
        
        // Function to create a communication card
        function createCommunicationCard(doc) {
            const data = doc.data();
            const card = document.createElement('div');
            card.id = `card-${doc.id}`;
            card.className = `card p-4 rounded-lg bg-white flex flex-col gap-2 ${data.status}`;
            
            // Display and edit forms for data
            const displayHTML = `
                <div class="flex items-center justify-between cursor-pointer collapsible-header">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800">이름: ${data.name || '없음'}</p>
                        <p class="text-sm text-gray-400">수신자: ${data.assignee || '미지정'}</p>
                    </div>
                    <svg class="w-5 h-5 ml-2 text-gray-400 transform transition-transform duration-300 collapsible-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
                <div class="collapsible-content space-y-2 text-sm text-gray-600 hidden">
                    <p><strong>번호:</strong> ${data.phone || '없음'}</p>
                    <p><strong>위치:</strong> ${data.where || '없음'}</p>
                    <p><strong>내용:</strong> ${data.what || '없음'}</p>
                    <p class="text-xs text-gray-400 mt-2">요청 시간: ${new Date(data.timestamp.toDate()).toLocaleString('ko-KR')}</p>
                    <p class="text-xs text-gray-400">작성자: ${data.authorName || '익명'}</p>
                </div>
            `;
            
            const editFormHTML = `
                <div class="flex flex-col gap-2 edit-form" id="edit-form-${doc.id}">
                    <input type="text" id="edit-name-${doc.id}" value="${data.name || ''}" placeholder="이름" class="p-2 border rounded text-sm">
                    <input type="text" id="edit-phone-${doc.id}" value="${data.phone || ''}" placeholder="번호" class="p-2 border rounded text-sm">
                    <input type="text" id="edit-where-${doc.id}" value="${data.where || ''}" placeholder="위치" class="p-2 border rounded text-sm">
                    <input type="text" id="edit-what-${doc.id}" value="${data.what || ''}" placeholder="내용" class="p-2 border rounded text-sm">
                    <input type="text" id="edit-assignee-${doc.id}" value="${data.assignee || ''}" placeholder="수신자" class="p-2 border rounded text-sm">
                </div>
            `;
            
            // Status change and edit buttons
            const buttonHTML = `
                <div class="flex gap-2 mt-2">
                    ${data.status === 'pending' ?
                        `<button data-status="in_progress" data-id="${doc.id}" class="status-btn px-4 py-2 bg-blue-500 text-white rounded-full text-xs font-semibold hover:bg-blue-600">진행 중으로</button>` : ''
                    }
                    ${data.status === 'in_progress' ?
                        `<button data-status="completed" data-id="${doc.id}" class="status-btn px-4 py-2 bg-green-500 text-white rounded-full text-xs font-semibold hover:bg-green-600">완료로</button>` : ''
                    }
                    ${data.status === 'completed' ?
                        `<span class="text-xs text-green-600 bg-green-100 py-1 px-3 rounded-full">처리 완료됨</span>` : ''
                    }
                    ${data.status !== 'completed' ?
                        `<button class="edit-btn px-4 py-2 bg-gray-500 text-white rounded-full text-xs font-semibold hover:bg-gray-600" data-id="${doc.id}">수정</button>` : ''
                    }
                </div>
            `;

            card.innerHTML = `
                <div class="display-view">${displayHTML}</div>
                <div class="edit-view hidden">${editFormHTML}</div>
                ${buttonHTML}
                <div class="edit-buttons hidden flex gap-2 mt-2">
                    <button class="save-btn px-4 py-2 bg-green-500 text-white rounded-full text-xs font-semibold hover:bg-green-600" data-id="${doc.id}">저장</button>
                    <button class="cancel-btn px-4 py-2 bg-gray-500 text-white rounded-full text-xs font-semibold hover:bg-gray-600" data-id="${doc.id}">취소</button>
                </div>
            `;

            // Add event listener for collapsing/expanding
            card.querySelector('.collapsible-header').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent card events from firing
                const content = card.querySelector('.collapsible-content');
                const icon = card.querySelector('.collapsible-icon');
                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
            return card;
        }

        // Firestore listener (real-time updates)
        function startRealtimeListener(collectionPath) {
            if (!isAuthReady) {
                console.error("Authentication not ready. Cannot start listener.");
                return;
            }

            const communicationRef = collection(db, collectionPath);
            console.log("Listening to collection:", collectionPath);

            unsubscribe = onSnapshot(communicationRef, (snapshot) => {
                currentBoardData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Clear existing lists
                pendingList.innerHTML = '';
                inProgressList.innerHTML = '';
                completedList.innerHTML = '';

                let pendingCountVal = 0;
                let inProgressCountVal = 0;
                let completedCountVal = 0;

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const card = createCommunicationCard(doc);
                    if (data.status === 'pending') {
                        pendingList.appendChild(card);
                        pendingCountVal++;
                    } else if (data.status === 'in_progress') {
                        inProgressList.appendChild(card);
                        inProgressCountVal++;
                    } else if (data.status === 'completed') {
                        completedList.appendChild(card);
                        completedCountVal++;
                    }
                });

                pendingCount.textContent = pendingCountVal;
                inProgressCount.textContent = inProgressCountVal;
                completedCount.textContent = completedCountVal;

                // Add event listeners to newly created buttons
                document.querySelectorAll('.status-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const newStatus = e.target.dataset.status;
                        const docId = e.target.dataset.id;
                        if (!docId) {
                            showModal("문서 ID를 찾을 수 없습니다.");
                            return;
                        }
                        try {
                            const communicationDocRef = doc(db, `${collectionPath}/${docId}`);
                            await updateDoc(communicationDocRef, { status: newStatus });
                            console.log(`Status updated for document ${docId} to ${newStatus}`);
                        } catch (error) {
                            console.error("문서 업데이트 중 오류 발생:", error);
                            showModal("상태를 업데이트하는 중 오류가 발생했습니다.");
                        }
                    });
                });

                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.id;
                        const cardElement = document.getElementById(`card-${docId}`);
                        const displayView = cardElement.querySelector('.display-view');
                        const editView = cardElement.querySelector('.edit-view');
                        const editButtons = cardElement.querySelector('.edit-buttons');

                        displayView.classList.add('hidden');
                        editView.classList.remove('hidden');
                        editButtons.classList.remove('hidden');
                        
                        const statusButtons = cardElement.querySelectorAll('.status-btn, .edit-btn');
                        statusButtons.forEach(btn => btn.classList.add('hidden'));
                    });
                });

                document.querySelectorAll('.save-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const docId = e.target.dataset.id;
                        const cardElement = document.getElementById(`card-${docId}`);
                        const name = cardElement.querySelector(`#edit-name-${docId}`).value;
                        const phone = cardElement.querySelector(`#edit-phone-${docId}`).value;
                        const where = cardElement.querySelector(`#edit-where-${docId}`).value;
                        const what = cardElement.querySelector(`#edit-what-${docId}`).value;
                        const assignee = cardElement.querySelector(`#edit-assignee-${docId}`).value;
                        
                        try {
                            const communicationDocRef = doc(db, `${collectionPath}/${docId}`);
                            await updateDoc(communicationDocRef, {
                                name, phone, where, what, assignee
                            });
                            showModal("요청이 성공적으로 수정되었습니다.");
                            console.log(`Document ${docId} updated with new content.`);
                        } catch (error) {
                            console.error("문서 수정 중 오류 발생:", error);
                            showModal("요청을 수정하는 중 오류가 발생했습니다.");
                        }
                    });
                });

                document.querySelectorAll('.cancel-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const docId = e.target.dataset.id;
                        const cardElement = document.getElementById(`card-${docId}`);
                        const displayView = cardElement.querySelector('.display-view');
                        const editView = cardElement.querySelector('.edit-view');
                        const editButtons = cardElement.querySelector('.edit-buttons');

                        displayView.classList.remove('hidden');
                        editView.classList.add('hidden');
                        editButtons.classList.add('hidden');
                        
                        const statusButtons = cardElement.querySelectorAll('.status-btn, .edit-btn');
                        statusButtons.forEach(btn => btn.classList.remove('hidden'));
                    });
                });
            }, (error) => {
                console.error("Firestore listener error:", error);
                showModal("데이터를 불러오는 중 오류가 발생했습니다.");
            });
        }

        // CSV download function
        function downloadAsCsv() {
            if (currentBoardData.length === 0) {
                showModal("다운로드할 데이터가 없습니다.");
                return;
            }

            // Set CSV headers
            const headers = ["타임스탬프", "이름", "번호", "위치", "내용", "수신자", "상태", "작성자"];
            
            // Format data for CSV
            const rows = currentBoardData.map(item => {
                const timestamp = item.timestamp ? new Date(item.timestamp.toDate()).toLocaleString('ko-KR') : '';
                const name = `"${item.name || ''}"`.replace(/"/g, '""');
                const phone = `"${item.phone || ''}"`.replace(/"/g, '""');
                const where = `"${item.where || ''}"`.replace(/"/g, '""');
                const what = `"${item.what || ''}"`.replace(/"/g, '""');
                const assignee = `"${item.assignee || ''}"`.replace(/"/g, '""');
                const status = `"${item.status || ''}"`.replace(/"/g, '""');
                const authorName = `"${item.authorName || ''}"`.replace(/"/g, '""');
                return [timestamp, name, phone, where, what, assignee, status, authorName].join(',');
            });

            // Combine into a single CSV string
            const csvString = [
                headers.join(','),
                ...rows
            ].join('\n');
            
            const BOM = "\uFEFF"; // Add BOM for Korean character support
            const blob = new Blob([BOM + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'communications.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Create a new board button
        createBoardButton.addEventListener('click', async () => {
            const boardName = boardNameInput.value.trim();
            if (boardName === '') {
                boardNameError.classList.remove('hidden');
                boardNameInput.focus();
                return;
            } else {
                boardNameError.classList.add('hidden');
            }
        
            if (!isAuthReady) {
                showModal("인증 준비 중입니다. 잠시 후 다시 시도해주세요.");
                return;
            }
        
            try {
                // Check if the board already exists
                const publicCollectionPath = `artifacts/${appId}/public/data/${boardName}`;
                const publicDocs = await getDocs(collection(db, publicCollectionPath));
        
                if (publicDocs.empty) {
                    // Board does not exist, so create a new one and navigate
                    updateBoard('협업 보드', boardName, publicCollectionPath);
                    console.log(`New board '${boardName}' created successfully.`);
                } else {
                    // Board already exists
                    boardNameError.textContent = "이미 존재하는 보드입니다. '기존 보드에 참여'를 이용해주세요.";
                    boardNameError.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error creating new board:", error);
                showModal("보드 생성 중 오류가 발생했습니다.");
            }
        });

        // Join an existing board
        joinBoardButton.addEventListener('click', async () => {
            const boardName = joinBoardInput.value.trim();
            if (boardName === '') {
                joinBoardError.classList.remove('hidden');
                joinBoardInput.focus();
                return;
            } else {
                joinBoardError.classList.add('hidden');
            }
        
            if (!isAuthReady) {
                showModal("인증 준비 중입니다. 잠시 후 다시 시도해주세요.");
                return;
            }
        
            try {
                // Check if the board exists
                const publicCollectionPath = `artifacts/${appId}/public/data/${boardName}`;
                const publicDocs = await getDocs(collection(db, publicCollectionPath));
        
                if (publicDocs.empty) {
                    joinBoardError.textContent = "해당 보드가 존재하지 않습니다.";
                    joinBoardError.classList.remove('hidden');
                } else {
                    updateBoard('협업 보드', boardName, publicCollectionPath);
                    console.log(`Joined existing board '${boardName}' successfully.`);
                }
            } catch (error) {
                console.error("Error joining board:", error);
                showModal("보드 참여 중 오류가 발생했습니다.");
            }
        });


        // Personal board button
        personalBoardButton.addEventListener('click', async () => {
            // Check if auth is ready before attempting to access
            if (!isAuthReady) {
                showModal("인증 준비 중입니다. 잠시 후 다시 시도해주세요.");
                return;
            }
            const personalCollectionPath = `artifacts/${appId}/users/${userId}/communications`;
            updateBoard('개인 보드', `사용자: ${userId.substring(0, 8)}...`, personalCollectionPath);
        });

        // Add button to add new communication
        addButton.addEventListener('click', async () => {
            const name = sourceNameInput.value.trim();
            const phone = sourcePhoneInput.value.trim();
            const where = whereInput.value.trim();
            const what = whatInput.value.trim();
            const assignee = assigneeInput.value.trim();
        
            if (!name || !phone || !where || !what || !assignee) {
                showModal("모든 필드를 채워주세요.");
                return;
            }

            if (!isAuthReady || !boardIdDisplay.textContent) {
                showModal("보드에 접속해야 요청을 추가할 수 있습니다.");
                return;
            }
        
            const currentCollectionPath = boardIdDisplay.textContent.startsWith('사용자')
                ? `artifacts/${appId}/users/${userId}/communications`
                : `artifacts/${appId}/public/data/${boardIdDisplay.textContent}`;
        
            try {
                await addDoc(collection(db, currentCollectionPath), {
                    name,
                    phone,
                    where,
                    what,
                    assignee,
                    status: 'pending',
                    timestamp: new Date(),
                    authorName: userName,
                });
                sourceNameInput.value = '';
                sourcePhoneInput.value = '';
                whereInput.value = '';
                whatInput.value = '';
                // assigneeInput.value = userName; // Keep assignee name
            } catch (error) {
                console.error("문서 추가 중 오류 발생:", error);
                showModal("요청을 추가하는 중 오류가 발생했습니다.");
            }
        });

        // Return to lobby button
        returnToLobbyButton.addEventListener('click', () => {
            lobbyScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
            if (unsubscribe) {
                unsubscribe();
            }
            // Clear input fields when returning to lobby
            boardNameInput.value = '';
            joinBoardInput.value = '';
            boardNameError.classList.add('hidden');
            joinBoardError.classList.add('hidden');
        });

        // Download button listener
        downloadButton.addEventListener('click', downloadAsCsv);

        // Auto-save functionality
        startAutoSaveButton.addEventListener('click', () => {
            if (autoSaveIntervalId) {
                showModal("이미 자동 저장이 실행 중입니다.");
                return;
            }

            const interval = parseInt(autoSaveIntervalSelect.value);
            autoSaveIntervalId = setInterval(() => {
                autoSaveStatus.textContent = '자동 저장 완료!';
                setTimeout(() => {
                    autoSaveStatus.textContent = '';
                }, 2000);
            }, interval);

            startAutoSaveButton.classList.add('hidden');
            stopAutoSaveButton.classList.remove('hidden');
        });

        stopAutoSaveButton.addEventListener('click', () => {
            if (autoSaveIntervalId) {
                clearInterval(autoSaveIntervalId);
                autoSaveIntervalId = null;
                autoSaveStatus.textContent = '자동 저장 중지됨.';
                setTimeout(() => {
                    autoSaveStatus.textContent = '';
                }, 2000);
            }

            startAutoSaveButton.classList.remove('hidden');
            stopAutoSaveButton.classList.add('hidden');
        });

    </script>
</body>
</html>
